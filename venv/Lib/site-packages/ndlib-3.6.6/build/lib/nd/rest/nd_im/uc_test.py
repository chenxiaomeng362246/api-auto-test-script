# coding=utf-8
import json
import os
from nd.rest.co_token.uc import UcToken
from nd.rest.nd_uc import UcEnv

__author__ = 'linzh'


from nd.rest.co_http.co_curl import Http as CurlClient, Http


class BaseHttp(object):
    def __init__(self, env=None, user=None, password=None, org=None, host=None):
        """
        env :UC登录的环境
        user：账号
        password：密码
        org:组织
        host：请求接口的host
        """
        self.env = env

        self.user = user
        print "password: " + password
        self.password = password
        self.org = org
        self.header = dict()
        self.header['Accept'] = 'application/json'
        self.header['Content-Type'] = 'application/json'

        self.port = ''
        self.host = host
        self.http_o = Http(self.host, self.port)
        self.http_o.set_header(self.header)
        self.token_o = None
        if self.env == 'ol':
            uc_env = UcEnv.ol
        else:
            uc_env = UcEnv.pre

        self.token_o = UcToken(uc_env)

    def get_auth(self, url='', method=''):
        """
        url:请求接口的url
        method：请求接口的方法
        获取authorization
        """
        # 可以使用固定账密，每次生成token
        access_token = self.token_o.get_token(self.user, self.password, self.org, url, method, self.host,)

        return access_token


def get_sender_list_from_file(fname):
    """

    """
    fp = open(u"..\\data/接收人配置/" + fname + u".txt", "rb")
    sender_list = []
    sender_dict = dict()
    while True:
        l = fp.readline()
        if l:
            sender_arr = l.split(' ')
            sender_list.append(sender_arr[1].rstrip())
            sender_dict[sender_arr[1].rstrip()] = sender_arr[0].rstrip().decode('utf-8')
        else:
            break
    return sender_list, sender_dict


def send_msg(msg, recv_fn, sender, sender_pwd):
    http = BaseHttp('ol', sender, sender_pwd, 'nd', 'im-agent.web.sdp.101.com')

    # uc_token = "Authorization: " + uc_token
    if os.environ.get("DEV_FOR_LINZH"):
        CurlClient.DEBUG = True
        http_o = CurlClient("im-agent.web.sdp.101.com", debug=True)
    else:
        http_o = CurlClient("im-agent.web.sdp.101.com")

    url = "http://im-agent.web.sdp.101.com"


    if isinstance(recv_fn, str):
        sender_list, sender_dict = get_sender_list_from_file(recv_fn)
        # sender_list = get_sender_list_from_file()
        # sender_list = ["10005074"]
    else:
        sender_list = recv_fn
        sender_dict = {}

        for sender_uid in sender_list:
            sender_dict[sender_uid] = u"您好"

    for i in range(0, len(sender_list)):
        sender_list2 = [sender_list[i]]

        msg2 = sender_dict[sender_list[i]] + u'，' + msg

        data = {
            "filter": [{
                "name": "uri",
                "args": {"uri_list": sender_list2}
            }],
            "body": {
                "content": "Content-Type:text/plain\r\n\r\n" + msg2,
                "flag": 0,
                "hide_sender": 0
            },
            "sender": 871101
        }

        uc_token = http.get_auth("/v0.2/api/agents/messages", "POST")
        header = {
            "Authorization": uc_token,
            "Content-Type": 'application/json'
        }
        http_o.set_header(header)
        res = http_o.post("/v0.2/api/agents/messages", json.dumps(data))

        print res
    return True
    # print(res)

if __name__ == '__main__':
    # sender_list, sender_dict = get_sender_list_from_file(u"测试1")
    # print sender_dict
    send_msg(u"测试", u"测试1")
    pass