# coding=utf-8

import os
import httplib
import re
from nd.rest import get_version_string

__author__ = 'linzh'


def get_version_list():
    def cmp_fun(x, y):
        x_l = x.split('.')
        y_l = y.split('.')

        x_v = 0
        y_v = 0
        if len(x_l) < 3:
            x_l.append(0)
        if len(y_l) < 3:
            y_l.append(0)

        ll = min(len(x_l), len(y_l))

        for i in range(ll):
            try:
                x_v += int(x_l[i]) * (10 ** (3-i))
                y_v += int(y_l[i]) * (10 ** (3-i))
            except Exception:
                print "error begin"
                print x_l, y_l
                print "error end"

        # print x_v, y_v
        if x_v > y_v:
            return 1
        if x_v < y_v:
            return -1
        return 0
    ptn = re.compile(r'<a href=.*>ndlib-([\d\.]+).tar.gz</a>')
    url = "http://fs.qa.huayu.nd:8202/simple/ndlib/"
    conn = None
    try:
        conn = httplib.HTTPConnection("fs.qa.huayu.nd", 8202, timeout=10)
        conn.request("GET", "/simple/ndlib/")
        res = conn.getresponse()
        res_data = res.read()
        matches = ptn.findall(res_data)
        cmp_fun("3.3.17", "3.3.2")
        matches = sorted(matches, cmp_fun)
        print matches
        return matches
    except Exception, err:
        print err
    finally:
        if conn:
            conn.close()


def get_last_version():
    return get_version_list()[-1]


if __name__ == "__main__":
    print get_last_version()
    # get_version_list()
